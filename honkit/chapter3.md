# 第3章 文脈自由文法の世界

第3章では、JSONの構文解析器を記述することを通して、基本的な構文解析の方法を学びました。また、構文解析器についても、PEG型の構文解析器および字句解析器を使った二通りを作ってみることで、構文解析器といっても色々な書き方があるのがわかってもらえたのではないかと思います。

この第4章では、現代の構文解析を語る上で必須である、文脈自由文法という概念について学ぶことにします。「文脈自由文法」というと、一見、堅くて難しそうな印象を持つ方も多いかもしれません。しかし、一言で言ってしまえば、BNFをよりシンプルに、数学的に厳密にしただけのものであって、厳しい言葉から漂う程難解な概念ではありません。一方で、「文脈自由文法」という概念を習得することによるメリットは計り知れないものがあります。たとえば、それによって、正規表現で記述出来ないが文脈自由言語（BNFと表現力では等価）で記述出来る「言語」を知ることが出来ますし、文脈自由言語では記述不可能な「言語」について知ることも出来ます。

さて、文脈自由文法の世界に飛び込んで見ましょう。

## 3.1 BNFと文脈自由文法

さて、いきなり文脈自由文法の定義を大上段に示しても抽象的過ぎますので、まず、比較的皆様に馴染みがあるBNFを文脈自由文法を用いた記述に変換することで、文脈自由文法についての理解のとっかかりとしたいと思います。お題は、「カッコの釣り合いの取れた文字列」です。

たとえば、

```
()
(())
((()))
(((())))
```

はカッコの釣り合いの取れた文字列の例です。一方で、

```
)(
(()
(()())
```

はカッコの釣り合いの取れていない文字列の例です。このような言語をDyck（ディック）言語と呼び、文脈自由文法を特徴づける言語とされています。

このDyck言語の文法を擬似BNFで記述してみると以下のようになります。

```bnf
D = P
P = "(" P ")" | ""
```

Dが構文解析の際に最初に参照される記号で開始記号と呼ばれます。さて、このBNFを文脈自由文法による記述になおしていきましょう。そのためには、まず、一番外側にある"|"を消去する必要があります。同時に、"="は"→"に置き換えます。

さて、早速置き換えてみましょう。

```cfg
D → P
P → "(" P ")"
P → ""
```

あれ？同じ名前Pを持つ記号が二つ出てきてしまいましたね。実は、文脈自由文法（の標準的な表記法）では、同じ名前の規則は複数出てきても構いません。その場合の解釈は、とりあえずBNFで同名の規則を"|"でくくった場合と同じようなものと思ってもらって構いません。

次に、これはどちらでもいいといえばいいのですが、慣習上、文脈自由文法を表記する上では、空文字列はεと書くことになっているので、これも置き換えましょう。

```cfg
D → P
P → "(" P ")"
P → ε
```

さらに、文脈自由文法では、「文字列リテラル」というものはなく、そのまま列を表記しますから、"("も(のように表記します。すると、以下のようになります。

```cfg
D → P
P → ( P )
P → ε
```

このようにして変換して出来た文脈自由文法（の一つ）ですが、この中で、

```cfg
D → P
```

のような、→で区切られた右と左をあわせて、生成規則と呼びます。また、DやPを非終端記号と呼び、'('は終端記号と呼ばれます。このようにして見ていくと、文脈自由文法とは、

- 生成規則の0個以上の並び

からなっており、各生成規則は、

- 左辺は、一個の終端記号
- 右辺は、一個以上の終端記号または非終端記号の並び

からなっていることがわかります。改めて、Dyck言語の、BNFによる表現と、文脈自由文法による表現を見てみることにします。

まず、BNFによる表現です。

```bnf
D = P
P = "(" P ")" | ""
```

次に、これを文脈自由文法に変換したものです。

```cfg
D → P
P → ( P )
P → ε
```

多少、表記として冗長になりましたが、そこまで大きくは変わらないことがわかると思います。さて、では、何故、BNFという表記法でなく、文脈自由文法に変換するかといえば、ひとえにそれは、4章以降で示す種々の構文解析アルゴリズムの多くが、文脈自由文法をベースに構築されているからです。また、構文解析を語る上で書かせない、構文木という概念を説明するためにも、文脈自由文法という概念は重要になります。以降の節では、このDyck言語を表現した文脈自由文法を元に、構文解析の基礎をなす様々な概念について説明していきます。

## 3.2 文脈自由文法と言語

さて、前の節で、Dyck言語について説明しましたが、その定義は以下のようなものでした。

```cfg
D → P
P → ( P )
P → ε
```

ところで、これまでは、「言語」という用語を明確な定義なしに使っていました。「言語」という言葉を一般的な文脈で使ったときに多くの人が思い浮かべるのは、日本語や英語、フランス語、などのいわゆる自然言語でしょう。ただ、この書籍で扱う「言語」は、主にプログラミング言語のような**曖昧さ**を持たないものです。たとえば、JavaやRuby、Pythonといったプログラミング言語の文法には曖昧さがなく、同じテキストは常に同じプログラムを意味します。

さて、では、たとえば、Java言語といったときに、この「言語」が指すものは何なのでしょうか？文脈自由文法のような形式文法の世界では、「言語」を**文字列の集合**として取り扱います。といっても、これでは、若干抽象的ですね。たとえば、以下のHello, World!プログラムは、Java言語のプログラムですが、文字列として見ることも出来ます。

```java
public class HelloWorld { public static void main(String[] args) { System.out.println("Hello, World!"); }}
```

さらに、別のプログラムとして、3を表示するだけのプログラムを考えてみます。一番単純な形は以下のようになるでしょう。

```java
public class Print3 { public static void main(String[] args) { System.out.println(3); }}
```

このようにして、「Java言語のプログラムとして認められる文字列」を列挙していくと、次のようになります。

```
{
  "public class HelloWorld { public static void main(String[] args) { System.out.println("Hello, World!"); }}",
  "public class Print3 { public static void main(String[] args) { System.out.println(3); }}",
  "public class Print4 { public static void main(String[] args) { System.out.println(4); }}",
  ...
}
```

Java言語のプログラムとして認められる文字列は無数にありますから、このような言語（＝文字列の集合）は多くの場合、**無限集合**になります。

別の例として、同様に、Rubyを「言語」として見ると次のようになります。

```
{
    "puts 'Hello, World!'",
    "puts 1",
    "puts 2",
    ...
}
```

Java言語と同様に、Rubyプログラムとして認められる文字列は無数にあるので、やはり無限集合となります。

さて、例をDyck言語に引き戻して、Dyck言語は一体何なのかを考えてみます。Dyck言語とは、「括弧の釣り合いが取れた文字列」を表すものでした。ということは、括弧の釣り合いが取れた文字列を集合として考えればいいことになります。

```
{
    "()",
    "(())",
    "((()))",
    "(()())",
    ...
}
```

というわけで、言語を文字列の集合として見ることについて、なんとなくは掴めて来たのではないかと思います。では、言語をこう見る意味は一体何なのでしょうか？

まずは、こう見ることによって、言語というものを、集合論の立場で論じられることが一番大きいです。たとえば、上記のDyck言語を表す無限集合をDKと表記したとします。この時、Dyck言語の条件を満たす文字列"()"について、

```
"()" ∈ DK
```

と表記する事が可能になります。一方で、Dyck言語でない文字列")("は、

```
")(" ¬∈ DK
```

と表記することが可能になります。DKは単なる集合なので、皆さんが中学や高校で習ったように、和や積などについて考えることができます。たとえば、Ruby言語を表す無限集合をRBと考えたとき、二つの集合の和RB∪DKを考えることが出来ます。RB∪DKは以下のようになります。

```
RB ∪ DK = {
  "()",
  "puts 1",
  "(())",
  "puts 2",
  ...
}
```

また、二つの集合の積RB∩DKを考えることも出来ます。RB∩DKは以下のようになります。

```
RB ∩ DK = {}
```

明らかに、Ruby言語のプログラムでかつDyck言語であるような文字列は存在しませんから、RB∩DKは**空集合**になります。

このように、集合論の道具を自由に使えるので、たとえば、Java 5のプログラムを表す集合をJ5、Java 8のプログラムを表す集合をJ8とすると、

```
J5 ⊂ J8
```

と表記することが出来ます。Javaは概ね、バージョンが上がっても、後方互換性を維持していると言われますが、集合論上はこのように考えることも出来るわけです。

## 3.3 文脈自由言語と言語の階層

ここまでで見て来たように、**ある**文脈自由文法は、言語、つまり、文字列の集合を定義するのでした。ところで、**全ての**文脈自由文法、言い換えれば文脈自由文法自体の集合はどのようなものになるのでしょうか？

これを考えるためには、おそらく皆さんが普段駆使しておられる正規表現を思い浮かべてもらうのがわかりやすいと思います。正規表現については今更説明は不要かと思いますが、多少解説します。（後で正規表現の解説を入れる）

さて、正規表現の集合（これを正規言語と呼び、本書ではREと表記します）が表すことが出来ないことを証明されている典型的な言語の一つが、実はDyck言語です。つまり、

```
DK ¬⊂ RE
```

となります。さらに話を進めると、文脈自由文法の集合（これを文脈自由言語と呼び、本書ではCFと表記します）とREについては、次のような関係がなりたちます。

```
RE ⊂ CF
```

これが意味していることは、文脈自由文法では、正規表現で表現可能なあらゆる文字列を表現可能だが、逆は成り立たないということです。つまり、どう足掻こうか、正規表現だけでは解決不能な問題があると言い換えることが出来ます。

では、文脈自由文法であらゆる種類の文字列の集合を定義可能なのでしょうか？これは、自明ではありませんが、不可能であることが証明されています。たとえば、aをn回、bをn回、cをn回だけ（n ≧＝ 0）並べた文字列を表す言語`a^nb^nc^n`は、文脈自由文法で定義不可能です。一方で、この言語は文脈依存言語（本書では、CSと表記）で定義可能であり、かつ、CFはCSの真部分集合です。このようにして、言語の表現能力には階層があり、

```
RE ⊂ CF ⊂ CS ⊂ ...
```

と言うことが可能です。ちなみに、現時点でもっとも最強の言語は、帰納的加算言語と呼ばれており、これは、現存する（ほとんど全ての）プログラミング言語の能力と一致します。

## 3.x 文脈自由文法の数学的な定義（補足）

この書籍を読みすすめる上で、この節は特に必須ではありません。ただ、興味がある読者の方のために、数学的な意味で厳密な文脈自由文法の定義を示しておきます。

```
G = (V, Σ, R, S) ただし、
1. Vは非終端記号の有限集合
2. Σは終端記号の有限集合で、Σ∩V＝∅
3. Sは開始記号で、S∈V
4. RはVから(V∪Σ)*への関係でかつ、∃w∈(V∪Σ)* : (S, W) ∈ Rが成り立つ
```

と、いきなりどばっと小難しい定義が出てきましたね。しかし、どれも、それほど難しい事を言っているわけではありません。まず、1.ですが、これは、ある文脈自由文法の中には、その中で使われる非終端記号の有限な集合が含まれている必要があるということです。先程の定義ですと、

```
V = {D, P}
```

となります。次に、2.ですが、これは、ある文脈自由文法の中で使われる終端記号（アルファベットとも呼ばれます）の有限集合です。Σ∩V＝∅という条件は、非終端記号と終端記号がオーバーラップしてはいけないというのを堅苦しく言い換えただけです。DYCK言語ですと、

```
Σ = {(,)}
```

となります。εは、終端記号ではないことに注意してください。文脈自由言語は、「文字列の並びの集合」を表したものであり、その最小単位は「1文字」であるため、空文字列は特別な取り扱いが必要になります。3.は、直観的には構文解析を始めるときに参照する非終端記号で、Vに含まれるもののいずれかです。DYCK言語の例だと、

```
S = D
```

となります。最後に、4.ですが、これは、直観的には、文脈自由文法とは、規則の集合であるという事を厳密に述べています。「関係」というのは、数学用語で言うところの二項関係の事ですが、これについては、おそらく別途解説が必要かと思うので、次の節で説明します。

ともあれ、文脈自由文法といっても、定義はこのように非常にシンプルなものです。とっつきやすくなった…でしょうか。たぶん、なっていないと思います。

「∃とか、*とか、「関係」とか、一体何なんだよー」

という声が聞こえて来そうです。というわけで、次の節では、文脈自由文法を理解するために、最低限必要な集合論上の道具立てについて解説することにします。

### 3.x.1 文脈自由文法のための集合論（補足）

この項では、文脈自由文法の数学的な定義を理解するために必要な、集合論の基礎について簡単に解説したいと思います。と、偉そうに集合論上の道具立てと言いましたが、私自身、別段、集合論の専門家でも数学の専門家でもありませんので、サクっと済ませてしまおうと思います。